# Lesson 3: Form Submission

In this lesson, we'll enhance the "Start Trip" form to save the initial trip details (date, start time, start weather) to offline storage using IndexedDB via RADFish. We'll also navigate the user to the next step in the form process, the "Catch Log" page.

## Step 1: Understanding RADFish Storage

Before we save data, let's understand how RADFish organizes and structures data using schemas and collections.

### 1.1: The Form Schema

RADFish uses **schemas** to define the structure and validation rules for your data. Think of a schema as a blueprint that tells RADFish what fields your data should have, their types, and any constraints.

The Form schema for our trip application is defined in `src/index.jsx` within the RADFish Application configuration. **You'll need to add the fields for the start trip data (`tripDate`, `startTime`, `startWeather`) to the schema as shown in the highlighted lines below:**

```jsx title="src/index.jsx" showLineNumbers=13
stores: {
  trip: {
    connector: new IndexedDBConnector("learn-radfish"),
    collections: {
      Form: {
        schema: {
          fields: {
            id: {
              type: "string",
              primaryKey: true,
            },
            step: {
              type: "number",
              required: true,
              default: 1
            },
            status: {
              type: "string",
              required: true,
              default: "none",
            },
            // diff-add-start
            tripDate: {
              type: "string",
              required: true,
            },
            startTime: {
              type: "string",
              required: true,
            },
            startWeather: {
              type: "string",
              required: true,
            },
            //diff-add-end
          },
        },
      },
    },
  },
},
```

**Understanding the Structure:**

- **`stores`**: The top-level container that holds all your application's data stores
- **`trip`**: Our specific store name - you can have multiple stores for different domains (e.g., "users", "settings", "inventory")
- **`connector: new IndexedDBConnector("learn-radfish")`**: Specifies that this store uses IndexedDB as the storage backend, with "learn-radfish" as the database name
- **`collections`**: Contains all the different types of data within this store (we'll add a "Catch" collection later for fish catch records)

**Key Schema Concepts:**

- **Fields**: Define the structure of your data - each field represents a piece of information we want to store
- **Types**: Specify what kind of data each field accepts (`string`, `number`, `timestamp`, etc.)
- **Primary Key**: The `id` field serves as a unique identifier for each trip record
- **Required**: Fields marked as `required: true` must have a value when creating records
- **Defaults**: Provide initial values for fields when records are created

This schema ensures data consistency and provides validation when we create or update trip records in IndexedDB. To read more about RADFish storage, visit the [RADFish Storage documentation](https://nmfs-radfish.github.io/radfish/design-system/storage).

### 1.2: Import and access the RADFish application

To access our RADFish stores and collections, we need to import the `useApplication` hook and use it in our component.

First, add these imports at the top of the `StartTrip.jsx` file:

```jsx title="src/pages/StartTrip.jsx"
import "../index.css";
import React, { useState, useEffect } from "react";
//diff-add-start
import { useApplication } from "@nmfs-radfish/react-radfish";
import { useTripNavigation, useTripData } from "../hooks";
//diff-add-end
```

Then, inside the `StartTrip` component, add the hooks:

```jsx title="src/pages/StartTrip.jsx"
export default function StartTrip() {
  //diff-add-start
  const app = useApplication();
  const { tripId, navigateHome, navigateWithTripId } = useTripNavigation();
  //diff-add-end
```

**Explanation:**

- **`useApplication()`**: This hook provides access to the RADFish application context, including all configured stores and collections
- **`app`**: The application object that contains our "trip" store and its collections
- **`useTripNavigation()`**: A custom hook that handles trip-specific navigation and provides:
  - `tripId`: The current trip ID from the URL parameters
  - `navigateHome`: Function to navigate back to the home page
  - `navigateWithTripId`: Function to navigate to other pages while preserving trip context

### 1.3: Declare the trip store and form collection

To save data, we first need to access the appropriate RADFish store and collection within our `handleSubmit` function.

```jsx title="src/pages/StartTrip.jsx"
const handleSubmit = async (e) => {
  e.preventDefault();

    try {
      let navigateToId = tripId;

      //diff-add-start
      const tripStore = app.stores["trip"];
      const Form = tripStore.getCollection("Form");
      //diff-add-end

      console.log("Form Data:", {
        tripDate: formData.tripDate,
        startWeather: formData.startWeather,
        startTime: formData.startTime,
        status: "in-progress",
        step: 2,
      });

    } catch (error) {
      console.error(
        "Error saving trip data:",
        error,
        "Trip ID:",
        tripId,
      );
    }
  }
 };
```

**Explanation:**

- `app.stores["trip"]`: Accesses the RADFish data store named "trip", which we configured in section 1.1. Stores group related data collections.
- `tripStore.getCollection("Form")`: Within the "trip" store, accesses the collection named "Form". Collections are analogous to tables in a relational database or collections in MongoDB; they hold the actual data records (in this case, our trip forms).

## Step 2: Saving Trip Data

### 2.1: Prepare the trip data object

Before we can save or update the trip, we need to prepare the data object with all the form values plus some metadata.

In lesson 2, we used `console.log()` to test our form data collection. Now we'll replace that with actual data preparation for storage.

```jsx title="src/pages/StartTrip.jsx"
const handleSubmit = async (e) => {
  e.preventDefault();

  try {
    let navigateToId = tripId;

    const tripStore = app.stores["trip"];
    const Form = tripStore.getCollection("Form");

    //diff-remove-start
    console.log("Form Data:", {
      tripDate: formData.tripDate,
      startWeather: formData.startWeather,
      startTime: formData.startTime,
      status: "in-progress",
      step: 2,
    });
    //diff-remove-end
    //diff-add-start
    const tripData = {
      tripDate: formData.tripDate,
      startWeather: formData.startWeather,
      startTime: formData.startTime,
      status: "in-progress",
      step: 2,
    };
    //diff-add-end
  } catch (error) {
    console.error("Error saving trip data:", error, "Trip ID:", tripId);
  }
};
```

### 2.2: Update existing trip or create new trip

Now we handle both scenarios: updating an existing trip or creating a brand new one.

```jsx title="src/pages/StartTrip.jsx"
const handleSubmit = async (e) => {
  e.preventDefault();

  try {
    let navigateToId = tripId;

    const tripStore = app.stores["trip"];
    const Form = tripStore.getCollection("Form");

    const tripData = {
      tripDate: formData.tripDate,
      startWeather: formData.startWeather,
      startTime: formData.startTime,
      status: "in-progress",
      step: 2,
    };

    //diff-add-start
    if (tripId) {
      await Form.update({ id: tripId, ...tripData });
    } else {
      const newTripId = crypto.randomUUID();
      await Form.create({
        id: newTripId,
        ...tripData,
      });
      navigateToId = newTripId;
    }
    //diff-add-end
  } catch (error) {
    console.error("Error saving trip data:", error, "Trip ID:", tripId);
  }
};
```

**Explanation:**

- **Update Path**: If `tripId` exists (from the `useTripNavigation` hook), we call `Form.update()` with the existing ID and our `tripData`. RADFish finds the record in IndexedDB and updates it with the new values.
- **Create Path**: If no `tripId`, it's a new trip:
  - Generate a unique ID using `crypto.randomUUID()`
  - Call `Form.create()` with the new ID and our `tripData`
  - Store the new ID for navigation

The `tripId` comes from the `useTripNavigation` hook, which manages trip routing and state. This `tripId` is used to check if a trip has already been created - if it exists, we're editing an existing trip; if not, we're creating a new one. For more details about this hook, visit the `/src/hooks/useTripNavigation.jsx` file.

Click the "Next" button to test the form submission. You should see the data being saved in IndexedDB.

:::tip Dev Tip: Inspecting IndexedDB

You can see the data being saved directly in your browser's developer tools:

1. Open your browser's developer tools (F12 or right-click â†’ Inspect).
2. Go to the "Application" tab (Chrome/Edge) or "Storage" tab (Firefox).
3. In the left-hand panel, find "IndexedDB".
4. Expand the database `learn-radfish`.
5. Expand the "trip" object store.
6. Click on the "Form" collection/index. You should see the trip data you just submitted.

![IndexedDB Inspection](./src/assets/lesson-3_step-2.2.png)
:::

### 2.3: Navigate to the next step

After successfully saving the data, we navigate the user to the Catch Log page.

Add the following navigation code after the create/update logic:

```jsx title="src/pages/StartTrip.jsx"
const handleSubmit = async (e) => {
  e.preventDefault();

  try {
    let navigateToId = tripId;

    const tripStore = app.stores["trip"];
    const Form = tripStore.getCollection("Form");

    const tripData = {
      tripDate: formData.tripDate,
      startWeather: formData.startWeather,
      startTime: formData.startTime,
      status: "in-progress",
      step: 2,
    };

    if (tripId) {
      await Form.update({ id: tripId, ...tripData });
    } else {
      const newTripId = crypto.randomUUID();
      await Form.create({
        id: newTripId,
        ...tripData,
      });
      navigateToId = newTripId;
    }
    //diff-add-start
    navigateWithTripId("/catch", navigateToId);
    //diff-add-end
  } catch (error) {
    console.error("Error saving trip data:", error, "Trip ID:", tripId);
  }
};
```

Then click the "Next" button to navigate to the Catch Log page.

**Explanation:**

- We use the `navigateWithTripId()` function from our custom `useTripNavigation` hook to go to the `/catch` route
- This custom function internally uses React Router's `navigate` function but adds trip-specific logic
- We pass the `tripId` (either existing or newly created) as the second parameter
- This ensures the Catch Log page receives the correct trip context and knows which trip it's associated with

## Conclusion

You have now successfully implemented the submission logic for the first step of the trip form! The application saves the initial trip details to IndexedDB using RADFish, handling both new trip creation and updates. Upon successful submission, the user is automatically navigated to the next step, ready to log their catches.
