# Lesson 3: Form Submission

In this lesson, we'll enhance the "Start Trip" form to save the initial trip details (date, time, weather) to offline storage using IndexedDB via RADFish. We'll also navigate the user to the next step in the form process, the "Catch Log" page.

## Step 1: Understanding RADFish Storage

Before we save data, let's understand how RADFish organizes and structures data using schemas and collections.

### 1.1: The Form Schema

RADFish uses **schemas** to define the structure and validation rules for your data. Think of a schema as a blueprint that tells RADFish what fields your data should have, their types, and any constraints.

The Form schema for our trip application is defined in `src/index.jsx` within the RADFish Application configuration:

```jsx title="src/index.jsx" showLineNumbers=20
stores: {
  trip: {
    connector: new IndexedDBConnector("learn-radfish"),
    collections: {
      Form: {
        schema: {
          fields: {
            id: {
              type: "string",
              primaryKey: true,
            },
            step: {
              type: "number",
              required: true,
              default: 1 // Track the current step (1: Start, 2: Catch, 3: End, 4: Review)
            },
            tripDate: {
              type: "string",
            },
            weather: {
              type: "string",
            },
            startTime: {
              type: "string",
            },
            endWeather: {
              type: "string",
            },
            endTime: {
              type: "string",
            },
            status: {
              type: "string",
              required: true,
              default: "none", // none, in-progress, Not Submitted, submitted
            },
          },
        },
      },
    },
  },
},
```

**Understanding the Structure:**

- **`stores`**: The top-level container that holds all your application's data stores
- **`trip`**: Our specific store name - you can have multiple stores for different domains (e.g., "users", "settings", "inventory")
- **`connector: new IndexedDBConnector("learn-radfish")`**: Specifies that this store uses IndexedDB as the storage backend, with "learn-radfish" as the database name
- **`collections`**: Contains all the different types of data within this store (we'll add a "Catch" collection later for fish catch records)

**Key Schema Concepts:**

- **Fields**: Define the structure of your data - each field represents a piece of information we want to store
- **Types**: Specify what kind of data each field accepts (`string`, `number`, `timestamp`, etc.)
- **Primary Key**: The `id` field serves as a unique identifier for each trip record
- **Required**: Fields marked as `required: true` must have a value when creating records
- **Defaults**: Provide initial values for fields when records are created

This schema ensures data consistency and provides validation when we create or update trip records in IndexedDB. To read more about RADFish storage, visit the [RADFish Storage documentation](https://nmfs-radfish.github.io/radfish/design-system/storage).

### 1.2: Declare the trip store and form collection

To save data, we first need to access the appropriate RADFish store and collection within our `handleSubmit` function.

Open `src/pages/StartTrip.jsx`. Locate the `// Access RADFish store and collection` comment and add the following code:

```jsx title="src/pages/StartTrip.jsx" showLineNumbers=202
try {
  // Access RADFish store and collection
  //diff-add-start
  const tripStore = app.stores["trip"];
  const Form = tripStore.getCollection("Form");
  //diff-add-end
```

**Explanation:**

- `app.stores["trip"]`: Accesses the RADFish data store named "trip", which we configured in section 1.1. Stores group related data collections.
- `tripStore.getCollection("Form")`: Within the "trip" store, accesses the collection named "Form". Collections are analogous to tables in a relational database or collections in MongoDB; they hold the actual data records (in this case, our trip forms).

## Step 2: Saving Trip Data

### 2.1: Prepare the trip data object

Before we can save or update the trip, we need to prepare the data object with all the form values plus some metadata. 

Locate the comment `// Prepare data to be saved` and add the following code:

```jsx title="src/pages/StartTrip.jsx" showLineNumbers=209
// Prepare data to be saved
//diff-add-start
const tripData = {
  tripDate: formData.tripDate,
  weather: formData.weather,
  startTime: formData.startTime,
  status: "in-progress", // Set status for new/updated trip
  step: 2 // Update step number
};
//diff-add-end
```

**Explanation:**

- We gather the form data (`tripDate`, `weather`, `startTime`) from our component's state
- We add metadata like `status: "in-progress"` to track that this trip is currently being worked on
- We set `step: 2` to indicate the user should proceed to the Catch Log page next

### 2.2: Update existing trip or create new trip

Now we handle both scenarios: updating an existing trip or creating a brand new one.

In the same file, locate `// Update the form if it exists, else create a new form` and add the following code:

```jsx title="src/pages/StartTrip.jsx" showLineNumbers=218
/* Update the form if it exists, else create a new form */
//diff-add-start
if (currentTripId) {
  // --- Update existing trip ---
  // Merge existing ID with new data and update in IndexedDB
  await Form.update({ id: currentTripId, ...tripData });
} else {
  // --- Create new trip ---
  const newTripId = crypto.randomUUID(); // Generate a unique ID
  // Add ID to data and create new record in IndexedDB
  await Form.create({ 
    id: newTripId, 
    ...tripData, 
    endWeather: "", 
    endTime: "" 
  });
  navigateToId = newTripId; // Store the new ID for navigation
  setCurrentTripId(newTripId); // Update state with the new ID
}
//diff-add-end
```

**Explanation:**

- **Update Path**: If `currentTripId` exists, we call `Form.update()` with the existing ID and our `tripData`. RADFish finds the record in IndexedDB and updates it with the new values.
- **Create Path**: If no `currentTripId`, it's a new trip:
  - Generate a unique ID using `crypto.randomUUID()`
  - Call `Form.create()` with the new ID, our `tripData`, plus empty values for fields from later steps (`endWeather`, `endTime`)
  - Store the new ID for navigation and update our component state

### 2.3: Navigate to the next step

After successfully saving the data, we navigate the user to the Catch Log page.

Add the following navigation code after the create/update logic:

```jsx title="src/pages/StartTrip.jsx" showLineNumbers=233
// Navigate to the next step (CatchLog), passing the tripId via state
//diff-add-start
navigate(`/catch`, { state: { tripId: navigateToId } });
//diff-add-end
```

**Explanation:**

- We use React Router's `navigate` function to go to the `/catch` route
- We pass the `tripId` (either existing or newly created) in the navigation state
- This allows the Catch Log page to know which trip it's associated with

:::tip Dev Tip: Inspecting IndexedDB

You can see the data being saved directly in your browser's developer tools:

1. Open your browser's developer tools (usually by pressing F12 or right-clicking and selecting "Inspect" or "Inspect Element").
2. Go to the "Application" tab (Chrome/Edge) or "Storage" tab (Firefox).
3. In the left-hand panel, find "IndexedDB".
4. Expand the database (it might be named after your application or have a default RADFish name).
5. Expand the "trip" object store.
6. Click on the "Form" collection/index. You should see the trip data you just submitted.
:::

## Conclusion

You have now successfully implemented the submission logic for the first step of the trip form! The application saves the initial trip details to IndexedDB using RADFish, handling both new trip creation and updates. Upon successful submission, the user is automatically navigated to the next step, ready to log their catches.
